<style>
  .content {
    width: 100%;
    height: auto;
    font-size: 0;
  }

  .content image {
    display: inline-block;
    width: 100%;
  }

  .comments {
    width: 100%;
    height: auto;
    padding-left: 30rpx;
    background: #fff;
    margin-top: 20rpx;
  }

  .comments .h {
    height: 93rpx;
    line-height: 93rpx;
    width: 720rpx;
    padding-right: 30rpx;
    border-bottom: 1px solid #d9d9d9;
  }

  .comments .h .t {
    display: block;
    float: left;
    width: 50%;
    font-size: 29rpx;
    color: #333;
  }

  .comments .h .i {
    display: block;
    float: right;
    margin-top: 30rpx;
    width: 33rpx;
    height: 33rpx;
  }

  .comments .b {
    height: auto;
    width: 720rpx;
  }

  .comments .item {
    height: auto;
    width: 720rpx;
    overflow: hidden;
    border-bottom: 1px solid #d9d9d9;
  }

  .comments .info {
    height: 127rpx;
    width: 100%;
    padding: 33rpx 0 27rpx 0;
  }

  .comments .user {
    float: left;
    width: auto;
    height: 67rpx;
    line-height: 67rpx;
    font-size: 0;
  }

  .comments .user .avatar {
    display: block;
    float: left;
    width: 67rpx;
    height: 67rpx;
    margin-right: 17rpx;
    border-radius: 50%;
  }

  .comments .user .nickname {
    display: block;
    width: auto;
    float: left;
    height: 66rpx;
    overflow: hidden;
    font-size: 29rpx;
    line-height: 66rpx;
  }

  .comments .time {
    display: block;
    float: right;
    width: auto;
    height: 67rpx;
    line-height: 67rpx;
    color: #7f7f7f;
    font-size: 25rpx;
    margin-right: 30rpx;
  }

  .comments .comment {
    width: 720rpx;
    padding-right: 30rpx;
    line-height: 45.8rpx;
    margin-bottom: 30rpx;
    font-size: 29rpx;
    color: #333;
  }

  .comments .load {
    width: 720rpx;
    height: 108rpx;
    line-height: 108rpx;
    text-align: center;
    font-size: 38.5rpx;
  }

  .no-comments {
    height: 297rpx;
  }

  .no-comments .txt {
    height: 43rpx;
    line-height: 43rpx;
    display: block;
    width: 100%;
    text-align: center;
    font-size: 29rpx;
    color: #7f7f7f;
  }

  .no-comments .icon {
    margin: 48rpx auto 18rpx auto;
    height: 130rpx;
    display: block;
    width: 115rpx;
  }

  .rec-box {
    width: 690rpx;
    height: auto;
    margin: 0 30rpx;
  }

  .rec-box .h {
    position: relative;
    width: 690rpx;
    height: 96rpx;
    /*border-bottom: 1px solid #d0d0d0;*/
    margin-bottom: 32rpx;
  }

  .rec-box .h .txt {
    display: inline-block;
    position: absolute;
    background: #f4f4f4;
    top: 59rpx;
    left: 200rpx;
    width: 290rpx;
    height: 45rpx;
    line-height: 45rpx;
    font-size: 30rpx;
    color: #999;
    text-align: center;
  }

  .rec-box .b .item {
    width: 690rpx;
    height: 397rpx;
    padding: 24rpx 24rpx 30rpx 24rpx;
    background: #fff;
    margin-bottom: 30rpx;
  }

  .rec-box .b .item .img {
    height: 278rpx;
    width: 642rpx;
  }

  .rec-box .b .item .title {
    display: block;
    margin-top: 30rpx;
    height: 30rpx;
    width: 642rpx;
    font-size: 28rpx;
  }

  /*@import "../lib/wxParse/wxParse.wxss";*/
</style>

<template>
  <scroll-view class="container">
    <scroll-view class="content">
      <import src="../lib/wxParse/wxParse.wxml"/>
      <template is="wxParse" data="{{wxParseData:topicDetail.nodes}}"/>
    </scroll-view>
    <view class="topic-goods">
    </view>
    <scroll-view class="comments">
      <view class="h">
        <text class="t">精选留言</text>
        <image bindtap="postComment" class="i"
               src="http://nos.netease.com/mailpub/hxm/yanxuan-wap/p/20150730/style/img/icon-normal/comment-add-2aca147c3f.png"></image>
      </view>
      <view class="has-comments" wx:if="{{commentList.length > 0 }}">
        <view class="b">
          <view class="item" wx:for="{{commentList}}" wx:key="{{item.id}}" wx:key="{{item.code}}">
            <view class="info">
              <view class="user">
                <image class="avatar" src="{{item.user_info.avatar}}"></image>
                <text class="nickname">{{item.user_info.nickname}}</text>
              </view>
              <view class="time">{{item.add_time}}</view>
            </view>
            <view class="comment">
              {{item.content}}
            </view>
          </view>
        </view>
        <view class="load" wx:if="{{commentCount > 5}}">
          <navigator url="/pages/topicComment?valueId={{topic.code}}&typeId=1">查看更多</navigator>
        </view>
      </view>
      <view class="no-comments" wx:if="{{commentList.length <= 0}}">
        <view class="b">
          <image class="icon"
                 src="http://yanxuan.nosdn.127.net/hxm/yanxuan-wap/p/20161201/style/img/icon-normal/no-comment-560f87660a.png"></image>
          <text class="txt">等你来留言</text>
        </view>
      </view>
    </scroll-view>
    <scroll-view class="rec-box">
      <view class="h">
        <text class="txt">专题推荐</text>
      </view>
      <view class="b">
        <navigator class="item" wx:for="{{topicList}}" url="/pages/topicDetail?id={{item.code}}" wx:key="{{item.code}}">
          <image class="img" src="{{item.scene_pic_url}}"></image>
          <text class="title">{{item.title}}</text>
        </navigator>
      </view>
    </scroll-view>
  </scroll-view>
</template>

<script>
  import wepy from 'wepy'
  import Fly from 'flyio/dist/npm/wx'
  import gql from "../config/gql";
  // import WxParse from '../lib/wxParse/wxParse.js'

  export default class TopicDetail extends wepy.page {
    constructor(props) {
      super(props)
      this.fly = new Fly
      //添加拦截器
      this.fly.interceptors.request.use((config, promise) => {
        //给所有请求添加自定义header
        config.headers["authorization"] = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7InNlcnZpY2UiOiJwcmlzbWEtZGVtb0BkZXYiLCJyb2xlcyI6WyJhZG1pbiJdfSwiaWF0IjoxNTI0ODI5MTY0LCJleHAiOjE1MjU0MzM5NjR9.AuSUr1qeADdnkqYi2GYkpEwKPbb3g9s670Jo37yHrJE";
        return config;
      })
    }

    onLoad = (options) => {
      // this.id = parseInt(options.id)
      //TODO 从后台传几个带评论的topic过来 展示用 此处暂时硬编码
      this.id = 314
      console.log(this.id)
      this.getTopic()
    }

    data = {
      id: 0,
      topic: {},
      topicList: [],
      commentCount: 0,
      commentList: []
    }

    getCommentList = async () => {
      const {data: {data: {comments: commentList}}} = await this.fly.post(gql.baseUrl, {
        ...gql.topic.topicCommentList,
        variables: {
          topic: this.id
        }
      })
      // console.log(data1)
      //TODO comment的内容需要base64解码 在后台完成
      this.commentList = commentList
      this.commentCount = commentList.length
      this.$apply()
    }

    methods = {
      postComment() {
        wx.navigateTo({
          url: `/pages/commentPost?valueId=${this.id}&typeId=1`
        })
      }
    }

    getTopic = async () => {
      const {data: {data: {topic}}} = await this.fly.post(gql.baseUrl, {
        ...gql.topic.topicById,
        variables: {
          code: this.id
        }
      })
      // console.log(data2)
      this.topic = topic
      // WxParse.wxParse('topicDetail', 'html', topic.content, this)
      const {data: {data: {topics: topicList}}} = await this.fly.post(gql.baseUrl, {
        ...gql.topic.relateTopics,
        variables: {
          code: this.id
        }
      })
      this.topicList = topicList
      this.$apply()
    }


    onShow = () => {
      this.getCommentList()
    }
  }
</script>
